<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>笑草暗号（しょうそうあんごう）</title>
<style>
:root {
  --bg: #0d1117;
  --card: #161b22;
  --accent: #58a6ff;
  --muted: #8b949e;
  --text: #c9d1d9;
  --error: #f85149;
}
html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Meiryo, sans-serif;background:var(--bg);color:var(--text);}
.wrap{max-width:980px;margin:0 auto;padding:28px}
.card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.5);}
h1{font-size:1.3rem;margin:0 0 6px;}
p.lead{margin:6px 0 16px;color:var(--muted);}
.cols{display:grid;grid-template-columns:1fr minmax(380px,1fr);gap:14px;}
@media (max-width:768px){
  .cols{grid-template-columns:1fr;}
}
textarea, .out{width:100%;box-sizing:border-box;}
textarea{min-height:160px;padding:12px;border-radius:8px;border:1px solid #30363d;background:#0d1117;color:var(--text);font-family:ui-monospace, "Roboto Mono", Menlo, Monaco, monospace;resize:vertical}
.controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
button{background:var(--accent);color:white;border:0;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:600}
button.secondary{background:#21262d;color:var(--accent);border:1px solid #30363d;}
.out{white-space:pre-wrap;background:#010409;color:var(--text);padding:12px;border-radius:8px;min-height:120px;font-family:ui-monospace, Menlo, monospace;overflow:auto}
.note{font-size:0.9rem;color:var(--muted);margin-top:8px}
table{width:100%;border-collapse:collapse;margin-top:12px;font-family:ui-monospace, Menlo, monospace;color:var(--text)}
th,td{border:1px solid #30363d;padding:6px;text-align:left}
th{background:#161b22}
.mini{font-size:0.9rem;color:var(--muted)}
.ok{color:#3fb950;font-weight:700}
.err{color:#f85149;font-weight:700}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>笑草暗号（しょうそうあんごう）</h1>
    <p class="lead">ルール：先頭1文字が種類フラグ（大文字=W、小文字=w、記号/半角スペース=草）。残り3文字は3進3桁（草=0, w=1, W=2）。記号は特殊番号指定（.=222, ?=202, !=111, '=101, "=201, ,=010, 半角スペース=000）。</p>

    <div class="cols">
      <div>
        <label><strong>入力（テキスト or 笑草暗号コード）</strong></label>
        <textarea id="input" placeholder="例: Abc!? または W草草草w草草 ..."></textarea>
        <div class="controls">
          <button id="encodeBtn">エンコード → コード</button>
          <button id="decodeBtn" class="secondary">デコード ← コード</button>
          <button id="copyBtn" class="secondary">コピー</button>
          <button id="clearBtn" class="secondary">クリア</button>
          <button id="tableBtn" class="secondary">対応表表示</button>
        </div>
        <p class="note">エンコードはA-Z, a-z, 記号 . , ' ! ? " と半角スペースのみ対応。デコードは w/W/草 のみ。</p>
      </div>

      <div>
        <label><strong>出力</strong></label>
        <div id="output" class="out"></div>
        <p class="mini">状態: <span id="status" class="mini">待機中</span></p>
      </div>
    </div>

    <div id="tableArea" style="margin-top:14px;display:none">
      <h3>対応表（A–Z, a–z, 記号, 半角スペース）</h3>
      <table id="mapTable"><thead><tr><th>文字</th><th>コード</th><th>説明</th></tr></thead><tbody></tbody></table>
    </div>

  </div>
</div>

<script>
(() => {
  const SYMBOLS = ['.','?', '!',"'", '"', ',', ' '];
  const SYMBOL_MAP = {'.':[2,2,2],'?':[2,0,2],'!':[1,1,1],"'":[1,0,1],'"':[2,0,1],',':[0,1,0],' ':[0,0,0]};
  const FLAG_UPPER='W', FLAG_LOWER='w', FLAG_SYM='草';
  const DIGIT_TO_GLYPH=['草','w','W'], GLYPH_TO_DIGIT={'草':0,'w':1,'W':2};

  function numberTo3Trits(n){return [Math.floor(n/9), Math.floor(n/3)%3, n%3];}
  function tritsToNumber(t){return t[0]*9 + t[1]*3 + t[2];}
  function tritsToGlyphs(t){return t.map(d=>DIGIT_TO_GLYPH[d]).join('');}
  function glyphsToTrits(s){return [...s].map(ch=>{if(!(ch in GLYPH_TO_DIGIT))throw new Error('不正なシンボル:'+ch);return GLYPH_TO_DIGIT[ch];});}

  function encodeTextToCode(text){
    let out='';for(const ch of text){
      if(ch>='A'&&ch<='Z'){out+=FLAG_UPPER+tritsToGlyphs(numberTo3Trits(ch.charCodeAt(0)-65));}
      else if(ch>='a'&&ch<='z'){out+=FLAG_LOWER+tritsToGlyphs(numberTo3Trits(ch.charCodeAt(0)-97));}
      else if(SYMBOLS.includes(ch)){out+=FLAG_SYM+tritsToGlyphs(SYMBOL_MAP[ch]);}
      else throw new Error('未対応文字:'+ch);
    }return out;
  }

  function decodeCodeToText(code){
    if(code.length%4!==0)throw new Error('長さは4の倍数である必要があります');
    let out='';for(let i=0;i<code.length;i+=4){
      const block=code.slice(i,i+4), flag=block[0], glyphs=block.slice(1);
      const trits=glyphsToTrits(glyphs);
      if(flag===FLAG_UPPER){out+=String.fromCharCode(65+tritsToNumber(trits));}
      else if(flag===FLAG_LOWER){out+=String.fromCharCode(97+tritsToNumber(trits));}
      else if(flag===FLAG_SYM){let found=null;for(const s of SYMBOLS){const t=SYMBOL_MAP[s];if(t[0]===trits[0]&&t[1]===trits[1]&&t[2]===trits[2]){found=s;break;}}if(!found)throw new Error('記号未定義:'+glyphs);out+=found;}
      else throw new Error('不明フラグ:'+flag);
    }return out;
  }

  const inputEl=document.getElementById('input'), outEl=document.getElementById('output'), statusEl=document.getElementById('status');
  const tableArea=document.getElementById('tableArea'), mapTableBody=document.querySelector('#mapTable tbody');

  function setStatus(text,err){statusEl.textContent=text;statusEl.className=err?'err':'ok';}

  document.getElementById('encodeBtn').addEventListener('click',()=>{try{outEl.textContent=encodeTextToCode(inputEl.value); setStatus('エンコード成功');}catch(e){outEl.textContent='エラー:'+e.message; setStatus('エンコードエラー',true);}});
  document.getElementById('decodeBtn').addEventListener('click',()=>{try{outEl.textContent=decodeCodeToText(inputEl.value); setStatus('デコード成功');}catch(e){outEl.textContent='エラー:'+e.message; setStatus('デコードエラー',true);}});
  document.getElementById('clearBtn').addEventListener('click',()=>{inputEl.value=''; outEl.textContent=''; setStatus('クリア完了');});
  document.getElementById('copyBtn').addEventListener('click',()=>{
    const text=outEl.textContent;
    if(!text){setStatus('コピー対象がありません',true);return;}
    navigator.clipboard.writeText(text).then(()=>{setStatus('コピー成功');}).catch(err=>{setStatus('コピー失敗: '+err,true);});
  });
  document.getElementById('tableBtn').addEventListener('click',()=>{if(tableArea.style.display==='none'){populateTable();tableArea.style.display='block';}else{tableArea.style.display='none';}});

  function populateTable(){
    mapTableBody.innerHTML='';
    for(let i=0;i<26;i++){const t=numberTo3Trits(i), g=tritsToGlyphs(t), code=FLAG_UPPER+g, ch=String.fromCharCode(65+i); mapTableBody.insertAdjacentHTML('beforeend',`<tr><td>${ch}</td><td>${code}</td><td>大文字 index=${i}</td></tr>`);}
    for(let i=0;i<26;i++){const t=numberTo3Trits(i), g=tritsToGlyphs(t), code=FLAG_LOWER+g, ch=String.fromCharCode(97+i); mapTableBody.insertAdjacentHTML('beforeend',`<tr><td>${ch}</td><td>${code}</td><td>小文字 index=${i}</td></tr>`);}
    for(const s of SYMBOLS){const t=SYMBOL_MAP[s], g=tritsToGlyphs(t), code=FLAG_SYM+g; const desc=s===' '?'半角スペース 固定':`記号 固定 (${t.join('')})`; mapTableBody.insertAdjacentHTML('beforeend',`<tr><td>${s}</td><td>${code}</td><td>${desc}</td></tr>`);}
  }

  setStatus('待機中');
})();
</script>
</body>
</html>
